
# Segmentation réseau et honeypots dans un homelab Blue Team

La  **segmentation réseau**  est une pratique clé de la défense en profondeur : elle consiste à diviser le réseau en zones isolées (VLAN, DMZ, sous-réseaux physiques) pour limiter la propagation d’une attaque. Comme le souligne l’OWASP, la segmentation est « au cœur de la défense en profondeur », car elle permet de construire une architecture sécurisée et isolée. En pratique, on crée au minimum plusieurs « zones de confiance » (LAN interne, DMZ publique, réseau des serveurs, etc.), chacune protégée par un pare-feu (firewall). Par exemple, pfSense (open-source) peut être utilisé comme pare-feu/routeur principal : il prend en charge les VLANs, le NAT et les DMZ et peut même intégrer des IDS/IPS (Snort ou Suricata). Un conseil éprouvé est d’isoler physiquement les zones de confiance : utiliser deux commutateurs distincts (un pour le WAN/DMZ et un pour les réseaux internes) afin qu’une mauvaise configuration de VLAN ne relie pas accidentellement Internet au LAN interne. On évitera aussi d’utiliser le VLAN 1 natif pour le trafic de données, car les protocoles de gestion réseau y transitent en clair.

Dans cette architecture, on définit souvent une  **DMZ**  (zone démilitarisée) en bordure : c’est un réseau isolé exposé à Internet, devant lequel se situent les services publics. Les honeypots sont idéalement déployés en DMZ ou dans des segments « leurres » dédiés, afin de piéger les attaquants sans compromettre le cœur du LAN. Conformément aux bonnes pratiques, chaque trafic externe qui pénètre la DMZ doit passer par le pare-feu, et tout trafic de la DMZ vers le réseau interne est fortement filtré. Les VLANs sur le commutateur et les règles de firewall pfSense garantissent ce cloisonnement. Par exemple, dans un homelab, on peut créer un VLAN  **DMZ**  pour les honeypots et un VLAN  **Production**  pour les serveurs sensibles, le tout sur pfSense en configurant les interfaces virtuelles et les règles de pare-feu appropriées. Les honeypots (machines factices) n’ont alors accès qu’à la DMZ et éventuellement à Internet, mais pas au LAN interne.

## Honeypots et systèmes de leurre

Un  **honeypot**  (ou « pot de miel ») est un dispositif ou service factice destiné à attirer les attaquants pour étudier leur comportement et générer des alertes. C’est un leurre censé paraître vulnérable afin de détourner et piéger l’intrus. Comme l’explique Ben Lutkevich (TechTarget), un honeypot est « un dispositif réseau qui trompe les hackers en leur faisant croire qu’ils ont pénétré un vrai réseau, alors qu’en réalité ils sont dans un système isolé conçu comme piège ». Concrètement, le honeypot émule des services courants (SSH, HTTP, FTP, etc.) avec de fausses données pour sembler réaliste. L’attaquant y croira, ce qui permet de  _détecter_  et d’_analyser_  ses actions en profondeur. Idéalement, on le place dans la DMZ (ou dans un segment isolé) : un firewall sépare la DMZ du réseau interne pour éviter toute propagation, comme le résume TechTarget, « la DMZ est une zone tampon sécurisée qui isole le réseau interne d’Internet ». Le honeypot apparaît alors depuis l’extérieur comme un composant vulnérable de ce réseau public, attirant l’attaquant. Une fois piégé, on le laisse agir suffisamment longtemps pour collecter un maximum d’informations sur ses techniques (attaques réseau, scans de ports, brute force SSH, etc.).

Il existe plusieurs types de honeypots :  **low-interaction**  (simples services factices),  **medium-interaction**  (émulent plusieurs services) et  **high-interaction**  (machines virtuelles entières, très réalistes mais complexes). Dans un homelab Blue Team, on emploie souvent des honeypots de type moyen : par exemple  _Cowrie_, un honeypot SSH/Telnet open-source très populaire, qui enregistre toutes les tentatives de connexion et les commandes tapées par l’attaquant. D’autres outils comme  _Glastopf_  (piège web),  _Conpot_  (pour systèmes industriels) ou l’« ensemble » Modern Honey Network/T-Pot peuvent être utilisés pour couvrir différents protocoles. Une pratique recommandée est de déployer un honeypot sur chaque segment interne critique. Héctor Herrero (blog Bujarra) suggère ainsi de « déployer un honeypot léger dans chaque segment de réseau que nous avons… pour détecter les curieux, bots ou scans de ports sur notre réseau interne ».

Les honeypots fournissent des informations précieuses sur les tactiques des attaquants. Leurs journaux (logs) peuvent être centralisés dans un SIEM (par ex. ELK, Graylog, Wazuh) pour corrélation. Par exemple, un laboratoire de type  _SOC homelab_  met souvent un honeypot web (DVWA) et un honeypot SSH (Cowrie) en DMZ, et enregistre automatiquement toute activité dans le SIEM. Un tel scénario est décrit par Ankeshraj (mai 2025) : « la zone publique DMZ présente un double honeypot : DVWA dans un conteneur Docker et un serveur SSH Cowrie. Toute activité attaquante y est enregistrée et remontée vers le SOC ». Cette combinaison permet au Blue Team de s’entraîner : par exemple, tout scan ou brute force détecté sur le honeypot génère immédiatement une alerte. Pendant ce temps, le honeypot étant isolé, l’attaquant n’atteint pas les vrais serveurs internes.

## Outils clés pour la segmentation et la détection

-   **pfSense (pare-feu/routeur)** : distribution BSD open-source très répandue pour la sécurisation des réseaux. Elle prend en charge les VLANs, la DMZ, le NAT et offre de nombreux packages (comme Snort/Suricata en IDS/IPS). En d’autres termes, « pfSense peut jouer un rôle d’IDS/IPS grâce à des paquets comme Snort et Suricata ». On l’installe typiquement sur une machine dédiée (PC, appliance ou VM) avec plusieurs interfaces réseau (WAN, LAN, DMZ) ou en mode tronc (802.1Q) pour gérer les VLANs. Les règles de firewall pfSense définissent quelles communications sont permises entre les zones (typiquement, bloquer tout trafic entrant vers le LAN sauf VPN, n’autoriser que ce qui est nécessaire vers la DMZ, etc.). Le package  _Suricata_  de pfSense offre de l’IDS/IPS en temps réel.
    
-   **Suricata (IDS/IPS)** : système open-source d’inspection réseau très performant. Il s’agit d’un moteur  _Network Security Monitoring_  (NSM) capable de surveiller tout le trafic d’une interface en mode promiscuous, de l’analyser selon des signatures et d’émettre des alertes en cas de détection d’une menace connue. Suricata gère de nombreux protocoles et permet, en mode IDS, de journaliser des événements suspects, ou en mode IPS, de bloquer des paquets. Son atout est sa versatilité (grand volume de trafic, règles personnalisables). Suricata s’intègre facilement dans un homelab (via pfSense ou en VM/container dédiée) et alimente le SIEM en alertes NIDS.
    
-   **Cowrie (honeypot SSH/Telnet)** : honeypot Python très utilisé pour piéger les attaquants sur les services SSH et Telnet. Cowrie enregistre les frappes clavier et les transferts de fichiers (wget, scp, sftp), fournissant un journal détaillé des actions de l’attaquant. Comme le note la documentation officielle, « Cowrie est un honeypot SSH/Telnet (de faible à moyenne interaction) conçu pour journaliser les attaques par bruteforce et les interactions en shell exécutées par l’attaquant ». Cowrie simule un vrai shell Unix (avec un faux système de fichiers) : par exemple, un attaquant pourra voir un fichier factice  `/etc/passwd`. Cowrie existe aussi sous forme d’image Docker sur Docker Hub. Par exemple, on peut rapidement tester Cowrie en lançant  `docker run -p 2222:2222 cowrie/cowrie:latest`. Cette portabilité Docker facilite son déploiement dans des containers isolés sur le homelab.
    
-   **VLAN (segmentation par commutateurs)** : technique incontournable pour isoler plusieurs réseaux sur un même switch géré. En homelab, on attribue différents ID VLAN aux ports/sous-interfaces pour séparer physiquement (au niveau L2) les flux. Par exemple, le VLAN 10 pour le LAN interne, VLAN 20 pour les honeypots, VLAN 30 pour l’IOT, etc. PfSense prend en charge les VLAN IEEE 802.1Q sur une interface. La documentation pfSense rappelle que les VLANs « segmentent un réseau et isolent des sous-réseaux », mais qu’il faut prendre garde aux configurations (ex.  **VLAN hopping**  si on n’éloigne pas le trafic non marqué VLAN 1). Par ailleurs, on appliquera les bonnes pratiques : ne pas laisser le VLAN 1 par défaut servir au trafic de données et protéger physiquement les ports en tronc (voir Doc pfSense).
    
-   **Docker/VM/LXC (virtualisation et conteneurs)** : les technologies de conteneurisation simplifient le déploiement de nombreuses briques. Par exemple, un honeypot comme Cowrie peut tourner dans un container Docker (image publique), facilement relié à un réseau dédié via le pont Docker. On peut aussi déployer des appliances virtuelles dans des VM ou LXC pour simuler des vulnérabilités (ex : DVWA, OWASP Juice Shop, un serveur Windows vulnérable, etc.). Les environnements comme Proxmox LXC/VM ou VMware permettent de créer plusieurs VMs interconnectées par VLANs virtuels. Un homelab typique pourrait lancer un pfSense en VM (ou sur un Proxmox LXC avec bridged NIC), des serveurs Linux/Windows en VM, et divers conteneurs Docker pour les honeypots ou outils d’analyse. Tout ceci est ensuite câblé (virtuellement) derrière le firewall pfSense ou un routeur logiciel afin de respecter la segmentation. Par exemple, la mise en place du honeypot « Caméléon » décrite par Bujarra utilise Docker pour déployer plusieurs honeypots (DNS, HTTP, SSH, etc.) dans un conteneur unique, exposé sur un port standard.
    

## Cas d’usage typiques en homelab Blue Team

-   **Attirer et observer les attaquants** : le honeypot sert de leurre pour détecter des scans et intrusions. Lorsqu’un malware ou un attaquant essaye de scanner le réseau, il tombe d’abord sur le honeypot isolé. Les connexions sont consignées (connexion SSH ratée dans Cowrie, requêtes HTTP malicieuses sur un honeypot web, tentatives de login sur un serveur factice, etc.). Le Blue Team peut alors investiguer à partir de ces journaux. Dans un lab comme celui d’Orange (GOAT Lab), l’objectif est précisément de « simuler des attaques et capturer des indicateurs de compromission pour entraîner la détection ». La segmentation permet ici de contenir toute attaque dans la zone « trompe-l’œil », sans risque pour l’infrastructure réelle.
    
-   **Détection d’intrusion réseau (NIDS)** : avec Suricata ou Snort activé sur le firewall (pfSense) ou sur un segment réseau (port mirroring), on surveille en parallèle le trafic de chaque VLAN. Suricata détectera par exemple un balayage de ports, des tentatives de signature connues (ex. CVE exploit, pattern de ransomware en action) et générera des alertes. Ces alertes, agrégées par le SIEM, complètent celles du honeypot. Par exemple, si le honeypot SSH (Cowrie) enregistre des tentatives de brute force, Suricata pourra observer ces mêmes paquets et confirmer l’attaque. Ces corrélations aident à affiner les règles.
    
-   **Segmentation de l’IoT et des environnements critiques** : dans un homelab, on pratique souvent la règle de distinguer les machines fragiles (périphériques IOT, HomeAssistant, cameras) du réseau professionnel simulé. Ces périphériques IOT sont placés sur un VLAN isolé, sans accès direct aux serveurs internes. On y applique des règles stricte (ex. seulement accès Internet et accès limité au NAS), évitant qu’une compromission d’un capteur ne donne un pivot facile vers le cœur du réseau. C’est l’application du principe Zero Trust et du « least privilege » réseau.
    
-   **Automatisation et alerting** : les honeypots et IDS sont configurés pour remonter automatiquement les alertes vers la plateforme centrale (ex. Graylog, ELK/Wazuh). Par exemple, un simple script peut envoyer par email ou par Slack une alerte dès qu’un honeypot est touché. Ainsi, même dans un cadre d’apprentissage, on peut tester des playbooks de réponse (isoler la machine compromise, vérifier logs, etc.).
    

## Installation et architecture type

Pour un homelab Blue Team, on préconise généralement une architecture multi-VM/containeurs :

-   **Firewall / Routeur principal** : exécutez pfSense sur une VM (KVM, VMware, Proxmox) ou sur du matériel dédié. Il aura au moins deux NIC : WAN (vers l’Internet ou un routeur upstream) et LAN (réseau interne). Le LAN physique est souvent relié à un switch managé (ou aux bridges Proxmox) qui a un port trunk lui permettant de transporter plusieurs VLAN vers le LAN.
    
-   **Switch virtuel / VLANs** : si vous utilisez Proxmox ou ESXi, créez des réseaux virtuels (VLAN 10, 20…) associés à des bridges. Branchez les VMs honeypots et IoT sur les VLANs correspondants. Par exemple, choisissez VLAN 100 pour DMZ/honeypots et VLAN 200 pour IoT. Dans pfSense, créez les interfaces VLAN correspondantes liées à votre interface physique LAN.
    
-   **Honeypots** : par exemple, lancez Cowrie dans un conteneur Docker sur le réseau VLAN 100 (DMZ). C’est simple avec la commande Docker officielle :  `docker run -d --name cowrie -p 2222:2222 cowrie/cowrie:latest`. De même, vous pouvez déployer d’autres honeypots (Glastopf pour piège web, Dionaea pour SMB/TFTP, Caméléon multi-honeypot, etc.) sur le même VLAN isolé. Dans pfSense, créez une règle qui n’autorise par défaut aucune connexion du WAN vers ce VLAN, sauf peut-être les ports spécifiés (1:1 NAT ou forwarding pour rendre le honeypot accessible de l’extérieur). Idéalement, chaque honeypot a une IP privée fixe dans le VLAN DMZ.
    
-   **Serveurs internes** : VMs Windows/Linux sur le VLAN interne (ex. VLAN 1 LAN). Installez sur chacun des agents de collecte de logs (Filebeat/Winlogbeat) afin d’alimenter la plateforme de SIEM. Vous pouvez aussi héberger un serveur de simulation d’entreprise (Active Directory, base de données) sur ce réseau isolé.
    
-   **Suricata / IDS** : installez Suricata soit directement sur pfSense (package) soit sur une VM dédiée en mode tap/mirroring. Configurez-le pour surveiller le trafic entrant. Les alertes seront envoyées au SIEM.
    
-   **SIEM et visualisation** : déployez une stack ELK/Graylog/Wazuh dans le LAN pour collecter et analyser les logs (y compris ceux générés par les honeypots et Suricata). Par exemple, Graylog peut ingérer les fichiers JSON de Cowrie pour les requêtes SSH. Kibana/Wazuh offre des dashboards de conformité pour visualiser les alertes.
    

Cette architecture peut être construite avec des conteneurs Docker : pfSense ne s’exécute pas en container, mais ses équivalents peuvent (ex. OPNsense). En pratique, on utilisera souvent pfSense sur une VM et tout le reste en conteneurs. Des solutions  _prepackaged_  existent : par exemple le stack Docker (contenant aussi souvent Filebeat). Ainsi, en quelques  `docker-compose up`, on obtient un environnement complet.

## Recommandations et bonnes pratiques

-   **Defense en profondeur** : gardez un principe « deny by default ». N’ouvrez que les ports indispensables entre zones. Par exemple, isoler la DMZ: du réseau interne on peut autoriser l’administration SSH/VPN du pfSense, mais en aucun cas laisser la DMZ initier des connexions vers le LAN.
    
-   **Matériel et ressources** : même pour un homelab, privilégiez de la RAM et du SSD rapide. Suricata et Elasticsearch sont gourmands en mémoire. pfSense avec IDS et VPN requiert au moins 2 Go de RAM, mieux 4 Go. Suricata bénéficiera de cœurs CPU multiples pour l’inspection. Un hôte de 8 Go de RAM peut suffire pour un petit lab.
    
-   **Mises à jour et maintenance** : tenez à jour vos listes de règles Suricata/Snort (EmergingThreats, Snort VRT). Mettez régulièrement à jour Cowrie (pour ne pas être identifié comme honeypot obsolète). Sauvegardez la config de pfSense (préférer la sauvegarde automatique). Surveillez l’occupation disque (les logs peuvent rapidement croître ; purgez ou archivez régulièrement).
    
-   **Sécurité interne** : même les honeypots doivent être durcis pour éviter d’être compromis et servir de tremplin. Par exemple, utilisez un honeypot non routé vers le LAN, ou en mode « console only ». Suricata et le firewall de l’hôte doivent empêcher toute connexion sortante non gérée. Activez TLS/SSL pour pfSense et tout accès admin, et appliquez l’authentification à deux facteurs si possible.
    
-   **Formation et exercices** : profitez de ce lab pour pratiquer des scénarios Blue Team. Par exemple, simulez une infection sur l’hôte Honeypot et vérifiez que Suricata la détecte. Orchestrez des attaques (port scans, bruteforce SSH) pour tester l’alerte et la réponse automatisée (playbooks Ansible ou scripts de remédiation). L’environnement GOAT Lab d’Orange (un lab d’entrainement offensif) illustre ce principe : chaque outil (pfSense, honeypot, IDS) y joue un rôle afin d’enseigner à l’ingénieur le cycle détection-réponse.
    

En résumé, pour un homelab défensif orienté Blue Team, on combinera  **pare-feu segmenté (pfSense + VLAN)**,  **IDS/IPS (Suricata)**  et  **honeypots (Cowrie, etc.)**  dans un réseau compartimenté. Cette combinaison permet de collecter de façon fiable les journaux de sécurité et de générer des alertes pertinentes. L’accent est mis sur la fiabilité de la collecte et la clarté des alertes. Chaque segment doit être isolé et les flux strictement contrôlés. Comme le préconise l’OWASP : la segmentation réseau, alliée au principe du moindre privilège, est un moyen de  **construire une architecture sécurisée où chaque segment reste aussi isolé que possible**
